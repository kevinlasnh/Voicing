name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    needs: [build-android, build-windows]  # ç­‰å¾…æž„å»ºå®Œæˆ

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Extract changelog for this release
        id: changelog
        run: |
          # ä»Ž CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
          VERSION="$VERSION"
          awk "/## \\[$VERSION\\]/{flag=1} flag{print} /^---$/{if(flag)exit}" CHANGELOG.md > release_notes.md

          # æ·»åŠ ä¸‹è½½è¯´æ˜Ž
          cat >> release_notes.md << 'EOF'

          ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž

          | æ–‡ä»¶ | è¯´æ˜Ž |
          |------|------|
          | `voicing.apk` | Android å®‰è£…åŒ… |
          | `voicing.exe` | Windows ç”µè„‘ç«¯ |

          ### ðŸš€ å¿«é€Ÿå¼€å§‹

          1. **ç”µè„‘ç«¯**ï¼šä¸‹è½½ EXE æ–‡ä»¶ï¼Œç›´æŽ¥è¿è¡Œ
          2. **æ‰‹æœºç«¯**ï¼šä¸‹è½½ APK æ–‡ä»¶ï¼Œå®‰è£…åˆ°æ‰‹æœº
          3. **è¿žæŽ¥**ï¼šå¼€å¯ Windows ç§»åŠ¨çƒ­ç‚¹ â†’ æ‰‹æœºè¿žæŽ¥ â†’ æ‰“å¼€ APK âœ…

          ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚

          - Windows 10/11 (64ä½)
          - Android 5.0+ (API 21+)

          EOF

          # è®¾ç½®è¾“å‡º
          {
            echo 'notes<<EOF' >> $GITHUB_OUTPUT
            cat release_notes.md >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Voicing ${{ env.VERSION }}
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.27.0
          cache: true

      - name: Verify Gradle wrapper config
        working-directory: android/voice_coding
        run: |
          echo "=== Checking gradle-wrapper.properties ==="
          cat android/gradle/wrapper/gradle-wrapper.properties
          echo ""
          echo "=== Root level gradle wrapper (if exists) ==="
          cat gradle/wrapper/gradle-wrapper.properties 2>/dev/null || echo "Not found"

      - name: Get dependencies
        working-directory: android/voice_coding
        run: flutter pub get

      - name: Build APK (Release)
        working-directory: android/voice_coding
        run: flutter build apk --release

      - name: Rename APK
        run: |
          mv android/voice_coding/build/app/outputs/flutter-apk/app-release.apk android/voice_coding/build/app/outputs/flutter-apk/voicing.apk

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: android/voice_coding/build/app/outputs/flutter-apk/voicing.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        working-directory: pc
        run: pip install -r requirements.txt

      - name: Build EXE with PyInstaller
        working-directory: pc
        run: |
          pyinstaller --onefile --windowed --name=VoiceCoding voice_coding.py

      - name: Rename EXE
        shell: powershell
        run: |
          Copy-Item "pc\dist\VoiceCoding.exe" -Destination "pc\dist\voicing.exe"

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: pc/dist/voicing.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
